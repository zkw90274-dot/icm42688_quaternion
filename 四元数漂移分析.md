# 30分钟静止测试 - 四元数漂移分析

## 测试数据

| 时间 | q0 | q1 | q2 | q3 |
|------|-----|-----|-----|-----|
| **初始** | 0.998000 | -0.024400 | 0.000000 | 0.000000 |
| **30分钟后** | 0.996200 | -0.040900 | -0.002300 | 0.049500 |
| **变化量** | -0.0018 | -0.0165 | -0.0023 | +0.0495 |

---

## 1️⃣ 归一化验证

```
初始模长：√(0.998² + 0.0244² + 0² + 0²) ≈ 0.9984 ≈ 1 ✅
30分钟后：√(0.9962² + 0.0409² + 0.0023² + 0.0495²) ≈ 0.9964 ≈ 1 ✅
```

**结论：** 四元数归一化保持良好，算法正常工作

---

## 2️⃣ 转换为欧拉角分析漂移

### 初始姿态

```c
Roll  = atan2(2(q0q1 + q2q3), 1 - 2(q1² + q2²))
      = atan2(2(0.998×(-0.0244) + 0), 1 - 2(0.0244² + 0))
      = atan2(-0.0487, 0.9988)
      = -2.80°

Pitch = asin(2(q0q2 - q3q1))
      = asin(2(0.998×0 - 0×(-0.0244)))
      = asin(0)
      = 0°

Yaw   = atan2(2(q0q3 + q1q2), 1 - 2(q2² + q3²))
      = atan2(2(0.998×0 + (-0.0244)×0), 1 - 2(0 + 0))
      = atan2(0, 1)
      = 0°
```

### 30分钟后姿态

```c
Roll  = atan2(2(q0q1 + q2q3), 1 - 2(q1² + q2²))
      = atan2(2(0.9962×(-0.0409) + (-0.0023)×0.0495), 1 - 2(0.0409² + 0.0023²))
      = atan2(-0.0813, 0.9966)
      = -4.67°

Pitch = asin(2(q0q2 - q3q1))
      = asin(2(0.9962×(-0.0023) - 0.0495×(-0.0409)))
      = asin(-0.0046 + 0.0020)
      = asin(-0.0026)
      = -0.15°

Yaw   = atan2(2(q0q3 + q1q2), 1 - 2(q2² + q3²))
      = atan2(2(0.9962×0.0495 + (-0.0409)×(-0.0023)), 1 - 2(0.0023² + 0.0495²))
      = atan2(0.0992, 0.9951)
      = 5.70°
```

---

## 3️⃣ 漂移统计

| 轴 | 初始角度 | 最终角度 | 漂移量 | 漂移率 |
|---|----------|----------|--------|--------|
| **Roll** | -2.80° | -4.67° | **-1.87°** | **3.74°/小时** |
| **Pitch** | 0° | -0.15° | **-0.15°** | **0.30°/小时** |
| **Yaw** | 0° | 5.70° | **+5.70°** | **11.4°/小时** |

---

## 4️⃣ 漂移原因分析

### Yaw 漂移最大（11.4°/小时）

**原因：**
1. Yaw 完全依赖陀螺仪积分
2. 陀螺仪零偏随温度/时间漂移
3. 即使校准过，残留 bias 仍会累积

**估算 bias：**
```
Yaw漂移 = ∫(gz_bias) dt
5.7° = gz_bias × 30分钟
gz_bias ≈ 0.19°/分钟 = 0.0032°/秒
```

### Roll 漂移次之（3.74°/小时）

**原因：**
1. 虽然有加速度计修正，但修正不完美
2. 可能原因：
   - 传感器安装不完全水平
   - 加速度计噪声
   - KP/KI 参数不够优化

### Pitch 漂移最小（0.30°/小时）

**原因：**
1. 重力在 Pitch 方向的投影最敏感
2. 加速度计修正效果最好

---

## 5️⃣ 性能评估

### 与行业标准对比

| 指标 | 你的测试 | 工业级6轴 | 消费级9轴 |
|------|----------|-----------|-----------|
| Yaw漂移 | 11.4°/h | 5-20°/h | <1°/h |
| Roll漂移 | 3.74°/h | <1°/h | <0.5°/h |
| Pitch漂移 | 0.30°/h | <0.5°/h | <0.2°/h |

**评价：** 你的 6 轴 AHRS 性能属于**正常水平**

---

## 6️⃣ 优化建议

### 方案1：减小 Yaw 漂移（有限改善）

```c
// 增加陀螺仪校准时间
const uint16_t calib_samples = 500;  // 从200增加到500

// 或者运行中持续校准（静止时检测）
void Online_GyroCalibration(void);
```

**预期效果：** Yaw 漂移降低到 5-8°/小时

---

### 方案2：优化 Roll/Pitch 参数

```c
// quaternion.h
#define MAHONY_KP  0.3f   // 尝试增大到 0.4-0.5
#define MAHONY_KI  0.002f // 保持不变
```

**预期效果：** Roll 漂移降低到 <2°/小时

---

### 方案3：添加磁力计（根本解决）✅ 推荐

**效果：**
- Yaw 漂移：<0.5°/小时
- 提供绝对航向（北方为0°）

**推荐芯片：**
- IST8310（便宜，I2C，约¥3）
- QMC5883L
- MMC5983MA（高精度）

---

## 7️⃣ 测试结论

### ✅ 做得好的地方

1. **归一化稳定** - 算法实现正确
2. **Pitch 漂移极小** - 0.30°/小时，非常优秀
3. **Roll 可接受** - 3.74°/小时，属于正常范围

### ⚠️ 需要改进

1. **Yaw 漂移较大** - 11.4°/小时，这是6轴的固有缺陷
2. **Roll 有偏差** - 初始就是 -2.80°，可能是安装角度

---

## 8️⃣ 快速验证

### 重新测试建议

```c
// 1. 确保传感器完全水平放置
// 2. 上电后等待1分钟再开始记录
// 3. 记录时避免振动、温度变化
// 4. 记录初始 Roll 值，应该是接近0°（目前是-2.8°）
```

### 初始角度异常检查

如果初始 Roll = -2.8°，说明：
1. 传感器安装不水平
2. 或者陀螺仪零偏校准不准确

**解决：**
```c
// 修改 main.c，初始化时清零姿态
// 在 Mahony_Init() 后添加：
// Serial_Printf("Initial Roll: %.2f°\r\n", euler.roll);
// 如果不是0°，重新校准或调整安装
```

---

## 📊 总结

| 项目 | 数值 | 评价 |
|------|------|------|
| 归一化 | ≈1.0 | ✅ 优秀 |
| Pitch漂移 | 0.30°/h | ✅ 优秀 |
| Roll漂移 | 3.74°/h | ⚠️ 正常 |
| Yaw漂移 | 11.4°/h | ⚠️ 6轴固有缺陷 |

**最终建议：**
- 如果应用需要稳定航向 → **添加磁力计**
- 如果只是相对旋转 → **接受现状或定期归零**
